'use client';

import React, { useState, useEffect, useMemo } from 'react';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!);

interface Product {
  id: string;
  name: string;
  price: number;
  image_url: string;
  category: string;
  discount?: number;
  stock_quantity?: number;
  created_at?: string;
  contact_type?: 'telegram' | 'whatsapp' | 'phone';
  contact_value?: string;
  sellers?: {
    shop_name: string;
    id: string;
    contact_type?: 'telegram' | 'whatsapp' | 'phone';
    contact_value?: string;
  };
}

interface Toast {
  id: string;
  message: string;
  type: 'success' | 'error' | 'warning';
}

interface Stats {
  totalProducts: number;
  lowStock: number;
  outOfStock: number;
  totalValue: number;
}

export default function AdminPage() {
  const [products, setProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('–í—Å–µ');
  const [toasts, setToasts] = useState<Toast[]>([]);
  const [stats, setStats] = useState<Stats>({
    totalProducts: 0,
    lowStock: 0,
    outOfStock: 0,
    totalValue: 0
  });

  useEffect(() => {
    fetchProducts();
  }, []);

  const fetchProducts = async () => {
    try {
      const { data, error } = await supabase
        .from('product_market')
        .select('*, sellers(shop_name, id)')
        .order('created_at', { ascending: false });

      if (error) throw error;
      setProducts(data || []);
      calculateStats(data || []);
    } catch (error) {
      console.error('Error loading products:', error);
    } finally {
      setLoading(false);
    }
  };

  const calculateStats = (products: Product[]) => {
    const totalProducts = products.length;
    const lowStock = products.filter(p => (p.stock_quantity || 0) > 0 && (p.stock_quantity || 0) <= 5).length;
    const outOfStock = products.filter(p => (p.stock_quantity || 0) === 0).length;
    const totalValue = products.reduce((sum, p) => sum + p.price * (p.stock_quantity || 0), 0);

    setStats({ totalProducts, lowStock, outOfStock, totalValue });
  };

  const addToast = (message: string, type: 'success' | 'error' | 'warning') => {
    const id = Date.now().toString();
    setToasts(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setToasts(prev => prev.filter(toast => toast.id !== id));
    }, 3000);
  };

  const categories = ['–í—Å–µ', ...Array.from(new Set(products.map(p => p.category)))];
  const filteredProducts = products.filter(p => 
    p.name.toLowerCase().includes(searchQuery.toLowerCase()) &&
    (selectedCategory === '–í—Å–µ' || p.category === selectedCategory)
  );

  const getStockStatus = (quantity?: number) => {
    const qty = quantity || 0;
    if (qty === 0) return { color: 'text-red-500', icon: 'üî¥', label: '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' };
    if (qty <= 5) return { color: 'text-yellow-500', icon: 'üü°', label: '–ú–∞–ª–æ' };
    return { color: 'text-green-500', icon: 'üü¢', label: '–í –Ω–∞–ª–∏—á–∏–∏' };
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900/20 to-slate-900 text-white p-6">
      {/* Toast Notifications */}
      <div className="fixed top-4 right-4 z-50 space-y-2">
        {toasts.map(toast => (
          <div
            key={toast.id}
            className={`px-6 py-3 rounded-lg shadow-lg backdrop-blur-sm border animate-pulse ${
              toast.type === 'success' ? 'bg-green-500/20 border-green-500 text-green-100' :
              toast.type === 'error' ? 'bg-red-500/20 border-red-500 text-red-100' :
              'bg-yellow-500/20 border-yellow-500 text-yellow-100'
            }`}
          >
            {toast.message}
          </div>
        ))}
      </div>

      {/* Header */}
      <div className="mb-8">
        <h1 className="text-6xl font-black italic bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 bg-clip-text text-transparent mb-2">
          Admin Panel
        </h1>
        <p className="text-purple-300 font-bold">MARKETPLACE TERMINAL v2.0</p>
      </div>

      {/* Stats Dashboard */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div className="bg-gradient-to-br from-slate-800/50 to-slate-900/50 p-6 rounded-2xl border border-cyan-500/20 backdrop-blur hover:border-cyan-500/50 transition-all hover-lift animate-fade-in-up">
          <div className="text-3xl mb-2 animate-pulse-slow">üì¶</div>
          <div className="text-2xl font-black text-cyan-400">{stats.totalProducts}</div>
          <div className="text-sm text-slate-400">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
        </div>
        <div className="bg-gradient-to-br from-slate-800/50 to-slate-900/50 p-6 rounded-2xl border border-yellow-500/20 backdrop-blur hover:border-yellow-500/50 transition-all hover-lift animate-fade-in-up">
          <div className="text-3xl mb-2 animate-pulse-slow">‚ö†Ô∏è</div>
          <div className="text-2xl font-black text-yellow-400">{stats.lowStock}</div>
          <div className="text-sm text-slate-400">–ú–∞–ª–æ –æ—Å—Ç–∞—Ç–æ–∫</div>
        </div>
        <div className="bg-gradient-to-br from-slate-800/50 to-slate-900/50 p-6 rounded-2xl border border-red-500/20 backdrop-blur hover:border-red-500/50 transition-all hover-lift animate-fade-in-up">
          <div className="text-3xl mb-2 animate-pulse-slow">üö´</div>
          <div className="text-2xl font-black text-red-400">{stats.outOfStock}</div>
          <div className="text-sm text-slate-400">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>
        </div>
        <div className="bg-gradient-to-br from-slate-800/50 to-slate-900/50 p-6 rounded-2xl border border-green-500/20 backdrop-blur hover:border-green-500/50 transition-all hover-lift animate-fade-in-up">
          <div className="text-3xl mb-2 animate-pulse-slow">üí∞</div>
          <div className="text-2xl font-black text-green-400">{stats.totalValue.toLocaleString()}‚ÇΩ</div>
          <div className="text-sm text-slate-400">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
        </div>
      </div>

      {/* Search and Filters */}
      <div className="bg-gradient-to-br from-slate-800/50 to-slate-900/50 p-6 rounded-2xl border border-purple-500/20 backdrop-blur mb-8">
        <div className="flex flex-col md:flex-row gap-4">
          <div className="flex-1 relative">
            <input
              type="text"
              placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full px-4 py-3 bg-slate-700/50 rounded-xl outline-none focus:ring-2 focus:ring-cyan-500 border border-purple-500/20 text-white placeholder-slate-400"
            />
            <span className="absolute right-4 top-1/2 -translate-y-1/2">üîç</span>
          </div>
          <select
            value={selectedCategory}
            onChange={(e) => setSelectedCategory(e.target.value)}
            className="px-4 py-3 bg-slate-700/50 rounded-xl outline-none focus:ring-2 focus:ring-cyan-500 border border-purple-500/20 text-white"
          >
            {categories.map(cat => (
              <option key={cat} value={cat}>{cat}</option>
            ))}
          </select>
          <button
            onClick={() => alert('–≠–∫—Å–ø–æ—Ä—Ç –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')}
            className="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-green-500/30 transition-all"
          >
            üìä –≠–∫—Å–ø–æ—Ä—Ç CSV
          </button>
        </div>
      </div>

      {/* Products Grid */}
      <div className="bg-gradient-to-br from-slate-800/50 to-slate-900/50 p-6 rounded-2xl border border-purple-500/20 backdrop-blur">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-black italic bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
            –¢–æ–≤–∞—Ä—ã ({filteredProducts.length})
          </h2>
        </div>
        
        {loading ? (
          <div className="flex items-center justify-center py-20">
            <div className="w-16 h-16 border-4 border-purple-500 rounded-full animate-spin"></div>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredProducts.map((product, index) => {
              const stockStatus = getStockStatus(product.stock_quantity);
              
              return (
                <div 
                  key={product.id} 
                  className="bg-gradient-to-br from-slate-700/50 to-slate-800/50 rounded-xl border border-purple-500/20 backdrop-blur transition-all hover:border-purple-500/50 hover:shadow-lg hover:shadow-purple-500/20 animate-fade-in-up"
                  style={{ animationDelay: `${index * 0.05}s` }}
                >
                  <div className="p-4">
                    <div className="flex items-start gap-3">
                      <img 
                        src={product.image_url} 
                        alt={product.name}
                        className="w-16 h-16 object-cover rounded-lg border border-slate-600"
                      />
                      <div className="flex-1 min-w-0">
                        <h3 className="font-bold text-white truncate">{product.name}</h3>
                        <p className="text-sm text-slate-400">{product.sellers?.shop_name || 'Unknown'}</p>
                        <div className="flex items-center gap-2 mt-2">
                          <span className="text-lg font-bold text-cyan-400">{product.price}‚ÇΩ</span>
                          {product.discount && (
                            <span className="text-xs px-2 py-1 bg-pink-500/20 text-pink-400 rounded">
                              -{product.discount}%
                            </span>
                          )}
                        </div>
                        <div className="flex items-center gap-2 mt-1">
                          <span className="text-sm">{stockStatus.icon}</span>
                          <span className={`text-sm font-medium ${stockStatus.color}`}>
                            {product.stock_quantity || 0} —à—Ç
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}
